stages:
  - build_deps
  - build_rpm

variables:
  GIT_SUBMODULE_STRATEGY: none
  RPM_VERSION: "1.0.5"
  RPM_RELEASE: "1"

build:dependencies:
  stage: build_deps
  image: almalinux:9
  tags:
    - pt-rhel-runner-01
  script:
    - echo "Installing C/C++ build tools and development libraries..."
    # Enable EPEL and CRB (CodeReady Linux Builder) for packages like oniguruma-devel and re2c
    - dnf install -y epel-release 'dnf-command(config-manager)' git
    - dnf config-manager --set-enabled crb
    # Configure git to ignore private submodules during update
    - git config submodule."src/Module/GithubBot".update none
    - git config submodule."src/Module/GitlabBridge".update none
    - git config submodule."src/Module/Cla".update none
    - git config submodule."src/Module/Monitor".update none
    - git config submodule."src/Module/Community".update none
    - git config submodule."src/Framework/Symfony".update none
    - git submodule update --init --recursive
    
    - dnf groupinstall -y "Development Tools"
    - dnf install -y cmake ncurses-devel openssl-devel libxml2-devel sqlite-devel oniguruma-devel readline-devel libcurl-devel gd-devel bison re2c git rsync
    - mkdir -p build_root/opt/projt-portal
    
    # 1. Build Custom Native NGINX
    - echo "================ COMPILING NGINX ================"
    - cd nginx
    - ./auto/configure --prefix=/opt/projt-portal/nginx --with-http_ssl_module --with-http_v2_module
    - make -j$(nproc)
    - make install DESTDIR=$CI_PROJECT_DIR/build_root
    - cd ..
    
    # 2. Build Custom Native PHP (with FPM)
    - echo "================ COMPILING PHP ================"
    - cd php
    - ./buildconf --force || true
    - ./configure --prefix=/opt/projt-portal/php --enable-fpm --with-mysqli --with-pdo-mysql --with-openssl --with-curl --with-zlib --enable-mbstring --without-sqlite3 --without-pdo-sqlite
    - make -j$(nproc)
    - make install INSTALL_ROOT=$CI_PROJECT_DIR/build_root
    - cd ..
    
    # 3. Build Custom Native MariaDB
    - echo "================ COMPILING MARIADB ================"
    - cd mariadb
    - mkdir -p build && cd build
    - cmake .. -DCMAKE_INSTALL_PREFIX=/opt/projt-portal/mariadb -DWITHOUT_TOKUDB=1 -DWITHOUT_MROONGA=1
    - make -j$(nproc)
    - make install DESTDIR=$CI_PROJECT_DIR/build_root
    - cd ../..
    
    # 4. Integrate Project Tick App Code & Runtimes
    - echo "================ SYNCING APP SOURCE ================"
    # Omit compiling source folders to save space
    - rsync -a --exclude nginx --exclude php --exclude mariadb --exclude .git --exclude build_root --exclude build ./ build_root/opt/projt-portal/
    
  artifacts:
    paths:
      - build_root/
    expire_in: 1 day

build:rpm:community:amd64:
  stage: build_rpm
  image: almalinux:9
  tags:
    - pt-rhel-runner-01
  dependencies:
    - build:dependencies
  script:
    - echo "Building highly optimized AM64 RPM for Project Tick Portal Community Edition..."
    - dnf install -y git
    # Configure git to ignore private submodules during update
    - git config submodule."src/Module/GithubBot".update none
    - git config submodule."src/Module/GitlabBridge".update none
    - git config submodule."src/Module/Cla".update none
    - git config submodule."src/Module/Monitor".update none
    - git config submodule."src/Module/Community".update none
    - git config submodule."src/Framework/Symfony".update none
    - git submodule update --init --recursive
    
    - dnf install -y rpm-build rpmlint
    - mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
    
    # Package dependencies and source code
    - cd build_root
    - tar -czf ~/rpmbuild/SOURCES/projt-portal.tar.gz opt
    - cd ..
    
    # Copy spec and compile RPM
    - cp .gitlab/projecttick-portal-community.spec ~/rpmbuild/SPECS/
    - rpmbuild -ba ~/rpmbuild/SPECS/projecttick-portal-community.spec
    
    # Export artifacts
    - mkdir -p build/community
    - cp ~/rpmbuild/RPMS/x86_64/*.rpm ./build/community/
  artifacts:
    paths:
      - build/community/*.rpm
    expire_in: 30 days

build:rpm:enterprise:amd64:
  stage: build_rpm
  image: almalinux:9
  tags:
    - pt-rhel-runner-01
  dependencies:
    - build:dependencies
  script:
    - echo "Building highly optimized AM64 RPM for Project Tick Portal Enterprise Edition..."
    - dnf install -y git
    # Configure git to ignore private submodules during update
    - git config submodule."src/Module/GithubBot".update none
    - git config submodule."src/Module/GitlabBridge".update none
    - git config submodule."src/Module/Cla".update none
    - git config submodule."src/Module/Monitor".update none
    - git config submodule."src/Module/Community".update none
    - git config submodule."src/Framework/Symfony".update none
    - git submodule update --init --recursive
    
    - dnf install -y rpm-build rpmlint php-cli php-zip
    - mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
    
    # Run the TickCrypto builder script to Encrypt Enterprise features
    # NOTE: The build script is injected via CI/CD secure variables, not stored in the git repo!
    - cd build_root/opt/projt-portal
    - echo "$TICKCRYPTO_BUILD_SCRIPT_B64" | base64 -d > run_encryptor.php
    - php run_encryptor.php
    - rm -f run_encryptor.php
    - cd ../..
    
    # Package dependencies and ENCRYPTED source code
    - cd build_root
    - tar -czf ~/rpmbuild/SOURCES/projt-portal.tar.gz opt
    - cd ..
    
    # Copy spec and compile RPM
    - cp .gitlab/projecttick-portal-enterprise.spec ~/rpmbuild/SPECS/
    - rpmbuild -ba ~/rpmbuild/SPECS/projecttick-portal-enterprise.spec
    
    # Export artifacts
    - mkdir -p build/enterprise
    - cp ~/rpmbuild/RPMS/x86_64/*.rpm ./build/enterprise/
  artifacts:
    paths:
      - build/enterprise/*.rpm
    expire_in: 30 days
