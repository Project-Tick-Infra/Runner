# Patch Receiver Workflow
# This workflow is triggered by the Project Tick GitLab Bridge.
# It downloads the project source from GitLab, applies the MR patch, and runs CI.
#
# Place this file at: .github/workflows/patch-receiver.yml
# Required Secrets: GL_BRIDGE_TOKEN (GitLab API token with read access)

name: "Patch Receiver"

on:
  workflow_dispatch:
    inputs:
      gitlab_project_id:
        description: "GitLab Project ID"
        required: true
        type: string
      gitlab_project_path:
        description: "GitLab project full path (e.g. project-tick/core/ProjT-Launcher)"
        required: true
        type: string
      gitlab_mr_iid:
        description: "GitLab MR IID"
        required: true
        type: string
      gitlab_sha:
        description: "GitLab commit SHA"
        required: true
        type: string
      gitlab_branch:
        description: "GitLab source branch name"
        required: true
        type: string
      gitlab_target_branch:
        description: "GitLab target branch name"
        required: true
        type: string
      context_prefix:
        description: "Context prefix (Shadow-Eval or ProjT-Launcher)"
        required: true
        type: string

jobs:
  receive-and-evaluate:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: "ğŸ“‹ Print Job Info"
        run: |
          echo "============================================"
          echo "ğŸ”— GitLab Project: ${{ inputs.gitlab_project_path }}"
          echo "ğŸ”€ MR: !${{ inputs.gitlab_mr_iid }}"
          echo "ğŸ”– SHA: ${{ inputs.gitlab_sha }}"
          echo "ğŸŒ¿ Branch: ${{ inputs.gitlab_branch }} -> ${{ inputs.gitlab_target_branch }}"
          echo "ğŸ“¦ Context: ${{ inputs.context_prefix }}"
          echo "============================================"

      - name: "â¬‡ï¸ Download Project Source from GitLab (target branch)"
        env:
          GL_TOKEN: ${{ secrets.GL_BRIDGE_TOKEN }}
        run: |
          # Download the target branch as a tarball from GitLab
          ARCHIVE_URL="https://gitlab.com/api/v4/projects/${{ inputs.gitlab_project_id }}/repository/archive.tar.gz?sha=${{ inputs.gitlab_target_branch }}"
          
          echo "ğŸ“¥ Downloading source archive from target branch: ${{ inputs.gitlab_target_branch }}"
          echo "   URL: $ARCHIVE_URL"
          
          HTTP_CODE=$(curl -s -o /tmp/source.tar.gz -w "%{http_code}" \
            -H "PRIVATE-TOKEN: $GL_TOKEN" \
            "$ARCHIVE_URL")
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Failed to download source archive (HTTP $HTTP_CODE)"
            exit 1
          fi
          
          ARCHIVE_SIZE=$(stat -c%s /tmp/source.tar.gz 2>/dev/null || stat -f%z /tmp/source.tar.gz 2>/dev/null || echo "0")
          echo "ğŸ“¦ Archive size: $(numfmt --to=iec $ARCHIVE_SIZE 2>/dev/null || echo ${ARCHIVE_SIZE} bytes)"
          
          # Extract into workspace
          mkdir -p $GITHUB_WORKSPACE/project
          tar -xzf /tmp/source.tar.gz -C $GITHUB_WORKSPACE/project --strip-components=1
          rm /tmp/source.tar.gz
          
          echo "âœ… Source extracted successfully"
          echo "ğŸ“‚ Top-level contents:"
          ls -la $GITHUB_WORKSPACE/project/ | head -20
          
          # Initialize git repo for patch application
          cd $GITHUB_WORKSPACE/project
          git init
          git add -A
          git config user.name "Project Tick Bridge"
          git config user.email "bridge@projecttick.org"
          git commit -m "Base: ${{ inputs.gitlab_target_branch }}" --quiet

      - name: "â¬‡ï¸ Download MR Patch from GitLab"
        env:
          GL_TOKEN: ${{ secrets.GL_BRIDGE_TOKEN }}
        run: |
          # Download the MR diff
          DIFF_URL="https://gitlab.com/${{ inputs.gitlab_project_path }}/-/merge_requests/${{ inputs.gitlab_mr_iid }}.diff"
          
          echo "ğŸ“¥ Downloading MR patch..."
          echo "   URL: $DIFF_URL"
          
          HTTP_CODE=$(curl -s -o /tmp/mr.diff -w "%{http_code}" \
            -H "PRIVATE-TOKEN: $GL_TOKEN" \
            "$DIFF_URL")
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âš ï¸ .diff endpoint failed (HTTP $HTTP_CODE), trying .patch format..."
            PATCH_URL="https://gitlab.com/${{ inputs.gitlab_project_path }}/-/merge_requests/${{ inputs.gitlab_mr_iid }}.patch"
            HTTP_CODE=$(curl -s -o /tmp/mr.diff -w "%{http_code}" \
              -H "PRIVATE-TOKEN: $GL_TOKEN" \
              "$PATCH_URL")
          fi
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âš ï¸ Direct download failed, trying API endpoint..."
            API_URL="https://gitlab.com/api/v4/projects/${{ inputs.gitlab_project_id }}/merge_requests/${{ inputs.gitlab_mr_iid }}/diffs"
            curl -s -H "PRIVATE-TOKEN: $GL_TOKEN" "$API_URL" > /tmp/mr_diffs.json
            
            # Convert API response to unified diff format
            python3 -c "
          import json, sys
          with open('/tmp/mr_diffs.json') as f:
              diffs = json.load(f)
          for d in diffs:
              print(d.get('diff', ''))
          " > /tmp/mr.diff 2>/dev/null || echo "API conversion failed"
          fi
          
          PATCH_SIZE=$(stat -c%s /tmp/mr.diff 2>/dev/null || stat -f%z /tmp/mr.diff 2>/dev/null || echo "0")
          echo "ğŸ“¦ Patch size: $(numfmt --to=iec $PATCH_SIZE 2>/dev/null || echo ${PATCH_SIZE} bytes)"
          
          if [ "$PATCH_SIZE" -lt 10 ]; then
            echo "âŒ Patch is empty or too small"
            exit 1
          fi
          
          echo "âœ… Patch downloaded successfully"

      - name: "ğŸ“Š Patch Statistics"
        run: |
          echo "=== Patch Summary ==="
          echo "Files changed: $(grep -c '^diff --git' /tmp/mr.diff || echo 0)"
          echo "Lines added:   $(grep -c '^+[^+]' /tmp/mr.diff || echo 0)"
          echo "Lines removed: $(grep -c '^-[^-]' /tmp/mr.diff || echo 0)"
          echo "Total lines:   $(wc -l < /tmp/mr.diff)"

      - name: "ğŸ©¹ Apply Patch"
        id: apply_patch
        working-directory: ${{ github.workspace }}/project
        run: |
          echo "ğŸ©¹ Applying patch to project source..."
          
          # Try clean apply first
          if git apply --check /tmp/mr.diff 2>/dev/null; then
            git apply /tmp/mr.diff
            echo "status=clean" >> $GITHUB_OUTPUT
            echo "âœ… Patch applied cleanly"
          elif git apply --check --3way /tmp/mr.diff 2>/dev/null; then
            git apply --3way /tmp/mr.diff
            echo "status=3way" >> $GITHUB_OUTPUT
            echo "âœ… Patch applied with 3-way merge"
          else
            echo "âš ï¸ Standard apply failed, trying relaxed mode..."
            git apply --reject --whitespace=fix /tmp/mr.diff 2>/dev/null || true
            
            REJECTS=$(find . -name "*.rej" -type f 2>/dev/null | wc -l)
            if [ "$REJECTS" -gt 0 ]; then
              echo "âš ï¸ $REJECTS reject file(s) found:"
              find . -name "*.rej" -type f 2>/dev/null | head -20
              echo "status=partial" >> $GITHUB_OUTPUT
            else
              echo "status=applied" >> $GITHUB_OUTPUT
            fi
          fi
          
          # Commit the patched state
          git add -A
          git commit -m "MR !${{ inputs.gitlab_mr_iid }}: ${{ inputs.gitlab_branch }} -> ${{ inputs.gitlab_target_branch }}

          Project: ${{ inputs.gitlab_project_path }}
          SHA: ${{ inputs.gitlab_sha }}
          Apply-Status: $(cat $GITHUB_OUTPUT | grep status | cut -d= -f2)" --quiet || echo "No changes to commit"

      - name: "ğŸ” Show Changes Summary"
        working-directory: ${{ github.workspace }}/project
        run: |
          echo "=== Applied Changes ==="
          git log --oneline -2
          echo ""
          echo "=== Files Modified ==="
          git diff --stat HEAD~1..HEAD 2>/dev/null || echo "No diff available"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # CI / Evaluation Steps
      # Add your project-specific CI steps below.
      # The project source with the MR patch applied is in:
      #   ${{ github.workspace }}/project/
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: "ğŸ—ï¸ Evaluate Build (Placeholder)"
        working-directory: ${{ github.workspace }}/project
        run: |
          echo "=== Build Evaluation ==="
          echo "Project: ${{ inputs.gitlab_project_path }}"
          echo "MR: !${{ inputs.gitlab_mr_iid }}"
          echo "Status: ${{ steps.apply_patch.outputs.status }}"
          echo ""
          echo "TODO: Add project-specific build/test commands here."
          echo "For example:"
          echo "  - C++/Qt projects: cmake --build ."
          echo "  - Python projects: pytest"
          echo "  - Node projects: npm test"
          echo ""
          echo "The full project source is available at: $(pwd)"
          echo "Files count: $(find . -type f | wc -l)"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Status Callbacks
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: "ğŸ”” Update GitLab Status (Success)"
        if: success()
        env:
          GL_TOKEN: ${{ secrets.GL_BRIDGE_TOKEN }}
        run: |
          curl -s -X POST \
            "https://gitlab.com/api/v4/projects/${{ inputs.gitlab_project_id }}/statuses/${{ inputs.gitlab_sha }}" \
            -H "PRIVATE-TOKEN: $GL_TOKEN" \
            -d "state=success" \
            -d "description=Patch applied (${{ steps.apply_patch.outputs.status }}) and evaluated" \
            -d "context=Shadow-Runner/Mirror" \
            -d "target_url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "âœ… GitLab status updated to success"

      - name: "ğŸ”” Update GitLab Status (Failure)"
        if: failure()
        env:
          GL_TOKEN: ${{ secrets.GL_BRIDGE_TOKEN }}
        run: |
          curl -s -X POST \
            "https://gitlab.com/api/v4/projects/${{ inputs.gitlab_project_id }}/statuses/${{ inputs.gitlab_sha }}" \
            -H "PRIVATE-TOKEN: $GL_TOKEN" \
            -d "state=failed" \
            -d "description=Patch evaluation failed. Check GitHub Actions log." \
            -d "context=Shadow-Runner/Mirror" \
            -d "target_url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "âŒ GitLab status updated to failed"
