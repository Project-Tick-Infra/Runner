# Kaotik Patch Receiver
# Triggered by Project Tick Bridge. Downloads patch from a GitHub Gist.
# NO GitLab tokens needed. The bridge server handles all GitLab communication.
#
# Place at: .github/workflows/patch-receiver.yml

name: "Patch Receiver"

on:
  workflow_dispatch:
    inputs:
      gitlab_project_id:
        description: "GitLab Project ID"
        required: true
        type: string
      gitlab_project_path:
        description: "GitLab project path"
        required: true
        type: string
      gitlab_mr_iid:
        description: "GitLab MR IID"
        required: true
        type: string
      gitlab_sha:
        description: "Commit SHA"
        required: true
        type: string
      gitlab_branch:
        description: "Source branch"
        required: true
        type: string
      gitlab_target_branch:
        description: "Target branch"
        required: true
        type: string
      context_prefix:
        description: "Context (Shadow-Eval or ProjT-Launcher)"
        required: true
        type: string
      patch_gist_url:
        description: "Raw URL of the patch Gist"
        required: true
        type: string
      archive_gist_url:
        description: "Raw URL of the archive Gist (optional)"
        required: false
        type: string
        default: ""

jobs:
  receive-and-evaluate:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: "üìã Job Info"
        run: |
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë  Project Tick - Kaotik Patch Receiver     ‚ïë"
          echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
          echo "‚ïë Project: ${{ inputs.gitlab_project_path }}"
          echo "‚ïë MR:      !${{ inputs.gitlab_mr_iid }}"
          echo "‚ïë SHA:     ${{ inputs.gitlab_sha }}"
          echo "‚ïë Branch:  ${{ inputs.gitlab_branch }} ‚Üí ${{ inputs.gitlab_target_branch }}"
          echo "‚ïë Context: ${{ inputs.context_prefix }}"
          echo "‚ïë Patch:   ${{ inputs.patch_gist_url }}"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"

      - name: "‚¨áÔ∏è Download Patch from Gist"
        run: |
          echo "üì• Downloading patch from Gist..."
          curl -sL "${{ inputs.patch_gist_url }}" -o /tmp/mr.diff
          
          PATCH_SIZE=$(stat -c%s /tmp/mr.diff 2>/dev/null || stat -f%z /tmp/mr.diff 2>/dev/null || echo "0")
          echo "üì¶ Patch size: ${PATCH_SIZE} bytes"
          
          if [ "$PATCH_SIZE" -lt 10 ]; then
            echo "‚ùå Patch is empty"
            exit 1
          fi
          
          echo "‚úÖ Patch downloaded"
          echo ""
          echo "=== Patch Stats ==="
          echo "Files changed: $(grep -c '^diff --git' /tmp/mr.diff || echo 0)"
          echo "Lines added:   $(grep -c '^+[^+]' /tmp/mr.diff || echo 0)"
          echo "Lines removed: $(grep -c '^-[^-]' /tmp/mr.diff || echo 0)"

      - name: "üìÇ Checkout Runner Repo"
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: "ü©π Apply Patch"
        id: apply_patch
        run: |
          EVAL_BRANCH="eval-mr-${{ inputs.gitlab_mr_iid }}-$(echo ${{ inputs.gitlab_sha }} | cut -c1-8)"
          git checkout -b "$EVAL_BRANCH"
          
          echo "ü©π Applying patch..."
          
          # Try methods in order of preference
          if git apply --check /tmp/mr.diff 2>/dev/null; then
            git apply /tmp/mr.diff
            echo "status=clean" >> $GITHUB_OUTPUT
            echo "‚úÖ Clean apply"
          elif git apply --check --3way /tmp/mr.diff 2>/dev/null; then
            git apply --3way /tmp/mr.diff
            echo "status=3way" >> $GITHUB_OUTPUT
            echo "‚úÖ 3-way merge apply"
          else
            # For cross-repo patches (different project into Runner), 
            # just store the diff as an artifact for review
            mkdir -p eval-patches
            cp /tmp/mr.diff "eval-patches/${{ inputs.gitlab_project_path }}-mr${{ inputs.gitlab_mr_iid }}.diff"
            echo "status=stored" >> $GITHUB_OUTPUT
            echo "üìÅ Patch stored as artifact (cross-repo patch)"
          fi
          
          git config user.name "Project Tick Bridge"
          git config user.email "bridge@projecttick.org"
          git add -A
          git commit -m "eval: ${{ inputs.gitlab_project_path }} MR!${{ inputs.gitlab_mr_iid }}
          
          Branch: ${{ inputs.gitlab_branch }} ‚Üí ${{ inputs.gitlab_target_branch }}
          SHA: ${{ inputs.gitlab_sha }}
          Context: ${{ inputs.context_prefix }}" --quiet --allow-empty
          
          echo "branch=$EVAL_BRANCH" >> $GITHUB_OUTPUT

      - name: "üìä Evaluation Summary"
        run: |
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë  Evaluation Result                        ‚ïë"
          echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
          echo "‚ïë Project:  ${{ inputs.gitlab_project_path }}"
          echo "‚ïë MR:       !${{ inputs.gitlab_mr_iid }}"
          echo "‚ïë Apply:    ${{ steps.apply_patch.outputs.status }}"
          echo "‚ïë Branch:   ${{ steps.apply_patch.outputs.branch }}"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"

      # ‚îÄ‚îÄ‚îÄ Add your CI steps here ‚îÄ‚îÄ‚îÄ
      # The patched code is in the current directory.
      # For cross-repo patches, the diff is in eval-patches/

      - name: "üîî Callback: Update GitLab Status"
        if: always()
        run: |
          # Call back to projecttick.org to update GitLab status
          STATE="success"
          DESC="Patch evaluated (${{ steps.apply_patch.outputs.status }})"
          
          if [ "${{ job.status }}" = "failure" ]; then
            STATE="failed"
            DESC="Evaluation failed. Check Actions log."
          fi
          
          # Use the bridge server's callback endpoint
          curl -sf -X POST "https://projecttick.org/api/bridge/callback" \
            -H "Content-Type: application/json" \
            -d "{
              \"project_id\": ${{ inputs.gitlab_project_id }},
              \"sha\": \"${{ inputs.gitlab_sha }}\",
              \"state\": \"$STATE\",
              \"description\": \"$DESC\",
              \"run_url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
            }" 2>/dev/null || echo "‚ö†Ô∏è Callback failed (bridge may handle this separately)"
