# Kaotik Patch Receiver - Full Source Mirror
# Downloads full project source from projecttick.org proxy,
# applies MR patch, pushes as eval branch to Runner repo.
# NO GitLab tokens needed on GitHub side.

name: "Patch Receiver"

on:
  workflow_dispatch:
    inputs:
      gitlab_project_id:
        description: "GitLab Project ID"
        required: true
        type: string
      gitlab_project_path:
        description: "GitLab project path"
        required: true
        type: string
      gitlab_mr_iid:
        description: "GitLab MR IID"
        required: true
        type: string
      gitlab_sha:
        description: "Commit SHA"
        required: true
        type: string
      gitlab_branch:
        description: "Source branch"
        required: true
        type: string
      gitlab_target_branch:
        description: "Target branch"
        required: true
        type: string
      context_prefix:
        description: "Context (Shadow-Eval or ProjT-Launcher)"
        required: true
        type: string
      patch_gist_url:
        description: "Raw URL of the patch Gist"
        required: true
        type: string
      archive_url:
        description: "URL to download full source archive"
        required: true
        type: string

jobs:
  receive-and-evaluate:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    permissions:
      contents: write

    steps:
      - name: "üìã Job Info"
        run: |
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë  Project Tick - Full Source Patch Receiver     ‚ïë"
          echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
          echo "‚ïë Project: ${{ inputs.gitlab_project_path }}"
          echo "‚ïë MR:      !${{ inputs.gitlab_mr_iid }}"
          echo "‚ïë SHA:     ${{ inputs.gitlab_sha }}"
          echo "‚ïë Branch:  ${{ inputs.gitlab_branch }} ‚Üí ${{ inputs.gitlab_target_branch }}"
          echo "‚ïë Context: ${{ inputs.context_prefix }}"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"

      - name: "üìÇ Checkout Runner Repo"
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: "‚¨áÔ∏è Download Full Source from Bridge Server"
        run: |
          echo "üì• Downloading full project source..."
          HTTP_CODE=$(curl -sL -o /tmp/source.tar.gz -w "%{http_code}" "${{ inputs.archive_url }}")
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå Failed to download source archive (HTTP $HTTP_CODE)"
            exit 1
          fi
          
          ARCHIVE_SIZE=$(stat -c%s /tmp/source.tar.gz 2>/dev/null || stat -f%z /tmp/source.tar.gz 2>/dev/null)
          echo "üì¶ Archive size: $(numfmt --to=iec $ARCHIVE_SIZE 2>/dev/null || echo ${ARCHIVE_SIZE} bytes)"
          
          # Clean workspace and extract source
          # Keep .git and .github dirs from Runner
          find . -mindepth 1 -maxdepth 1 ! -name '.git' ! -name '.github' -exec rm -rf {} +
          
          # Extract project source into workspace
          tar -xzf /tmp/source.tar.gz --strip-components=1
          rm /tmp/source.tar.gz
          
          echo "‚úÖ Full source extracted"
          echo "üìÇ Top-level contents:"
          ls -la | head -25

      - name: "‚¨áÔ∏è Download Patch from Gist"
        run: |
          echo "üì• Downloading MR patch..."
          curl -sL "${{ inputs.patch_gist_url }}" -o /tmp/mr.diff
          
          PATCH_SIZE=$(stat -c%s /tmp/mr.diff 2>/dev/null || stat -f%z /tmp/mr.diff 2>/dev/null)
          echo "üì¶ Patch size: ${PATCH_SIZE} bytes"
          
          echo "=== Patch Stats ==="
          echo "Files changed: $(grep -c '^diff --git' /tmp/mr.diff || echo 0)"
          echo "Lines added:   $(grep -c '^+[^+]' /tmp/mr.diff || echo 0)"
          echo "Lines removed: $(grep -c '^-[^-]' /tmp/mr.diff || echo 0)"

      - name: "ü©π Apply Patch"
        id: apply_patch
        run: |
          EVAL_BRANCH="eval-mr-${{ inputs.gitlab_mr_iid }}-$(echo ${{ inputs.gitlab_sha }} | cut -c1-8)"
          
          git config user.name "Project Tick Bridge"
          git config user.email "bridge@projecttick.org"
          
          # Commit the base source as-is
          git checkout -b "$EVAL_BRANCH"
          git add -A
          git commit -m "base: ${{ inputs.gitlab_project_path }} (${{ inputs.gitlab_target_branch }})" --quiet --allow-empty
          
          # Apply the MR patch on top
          echo "ü©π Applying MR patch..."
          if git apply --check /tmp/mr.diff 2>/dev/null; then
            git apply /tmp/mr.diff
            echo "status=clean" >> $GITHUB_OUTPUT
            echo "‚úÖ Patch applied cleanly"
          elif git apply --3way /tmp/mr.diff 2>/dev/null; then
            echo "status=3way" >> $GITHUB_OUTPUT
            echo "‚úÖ Patch applied with 3-way merge"
          else
            git apply --reject --whitespace=fix /tmp/mr.diff 2>/dev/null || true
            echo "status=partial" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Patch applied with possible rejects"
            find . -name "*.rej" -type f 2>/dev/null | head -10
          fi
          
          git add -A
          git commit -m "eval: MR !${{ inputs.gitlab_mr_iid }} (${{ inputs.gitlab_branch }})
          
          Project: ${{ inputs.gitlab_project_path }}
          SHA: ${{ inputs.gitlab_sha }}" --quiet --allow-empty
          
          echo "branch=$EVAL_BRANCH" >> $GITHUB_OUTPUT

      - name: "üöÄ Push Eval Branch"
        run: |
          EVAL_BRANCH="${{ steps.apply_patch.outputs.branch }}"
          echo "üöÄ Pushing full source + patch as: $EVAL_BRANCH"
          git push -f origin "$EVAL_BRANCH"
          echo "‚úÖ Branch pushed. Runner CI will now trigger on this branch."

      - name: "üìä Summary"
        run: |
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë  Mirror Complete                              ‚ïë"
          echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
          echo "‚ïë Project: ${{ inputs.gitlab_project_path }}"
          echo "‚ïë MR:      !${{ inputs.gitlab_mr_iid }}"
          echo "‚ïë Apply:   ${{ steps.apply_patch.outputs.status }}"
          echo "‚ïë Branch:  ${{ steps.apply_patch.outputs.branch }}"
          echo "‚ïë Files:   $(find . -type f -not -path './.git/*' | wc -l)"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"

      - name: "üîî Callback: Update GitLab Status"
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            STATE="success"
            DESC="Full mirror + patch applied (${{ steps.apply_patch.outputs.status }})"
          else
            STATE="failed"
            DESC="Mirror/patch failed. Check Actions log."
          fi
          
          curl -sf -X POST "https://projecttick.org/api/bridge/callback" \
            -H "Content-Type: application/json" \
            -d "{
              \"project_id\": ${{ inputs.gitlab_project_id }},
              \"sha\": \"${{ inputs.gitlab_sha }}\",
              \"state\": \"$STATE\",
              \"description\": \"$DESC\",
              \"run_url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
            }" 2>/dev/null || echo "‚ö†Ô∏è Callback skipped"
