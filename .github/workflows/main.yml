name: Shadow Bridge Runner
on: 
  workflow_dispatch:
    inputs:
      project_id: { required: true }
      project_full_name: { required: true }
      branch: { required: true }
      sha: { required: true }
      gitlab_url: { required: true }

jobs:
  shadow-runner:
    runs-on: ubuntu-latest
    steps:
      - name: "üîç Validate Environment"
        run: |
          if [ -z "${{ secrets.GL_BRIDGE_TOKEN }}" ]; then
            echo "‚ùå ERROR: GL_BRIDGE_TOKEN is MISSING in GitHub Secrets!"
            echo "Please go to Settings -> Secrets -> Actions and add GL_BRIDGE_TOKEN."
            exit 1
          fi
          if [ -z "${{ github.event.inputs.gitlab_url }}" ]; then
             echo "‚ùå ERROR: gitlab_url input is empty!"
             exit 1
          fi

      - name: "Status: Initializing Shadow Connection"
        run: |
          # URL'i g√ºvenli hale getirelim
          API_PATH="${{ github.event.inputs.gitlab_url }}/api/v4/projects/${{ github.event.inputs.project_id }}/statuses/${{ github.event.inputs.sha }}"
          # Context'teki bo≈üluƒüu encoding yapƒ±yoruz
          curl --request POST --header "PRIVATE-TOKEN: ${{ secrets.GL_BRIDGE_TOKEN }}" \
          "$API_PATH?state=running&context=Shadow-Runner/Init"

      - name: Fetch Code
        run: |
          git clone --branch ${{ github.event.inputs.branch }} \
          https://oauth2:${{ secrets.GL_BRIDGE_TOKEN }}@git.projecttick.org/${{ github.event.inputs.project_full_name }}.git .

      - name: üïµÔ∏è‚Äç‚ôÇÔ∏è Discover PR Workflows
        id: filter
        run: |
          mkdir -p .github/workflows
          FILES=$(ls .github/workflows/*.{yml,yaml} 2>/dev/null || echo "")
          FOUND_WF=""
          
          for f in $FILES; do
             # 'pull_request' tetikleyicisi kontrol√º
             IS_PR=$(yq e '.on' "$f" 2>/dev/null | grep -qi "pull_request" && echo "1" || echo "0")
             
             if [ "$IS_PR" == "1" ]; then
                FILENAME=$(basename "$f")
                echo "‚úÖ Found PR Workflow: $FILENAME"
                FOUND_WF="$FOUND_WF $FILENAME"
             fi
          done
          
          CLEAN_FOUND=$(echo $FOUND_WF | xargs)
          echo "selected_workflows=$CLEAN_FOUND" >> $GITHUB_OUTPUT

      - name: üöÄ Proxy Execution (Sequential)
        if: steps.filter.outputs.selected_workflows != ''
        shell: bash
        run: |
          set -e
          WORKFLOWS=(${{ steps.filter.outputs.selected_workflows }})
          
          for WF in "${WORKFLOWS[@]}"; do
            WF_PATH=".github/workflows/$WF"
            RAW_NAME=$(yq e '.name // "'$WF'"' "$WF_PATH")
            
            # URL Encoding for Workflow Name (Bash ile Python yardƒ±mƒ±yla)
            ENC_NAME=$(python3 -c "import urllib.parse; print(urllib.parse.quote('''$RAW_NAME'''))")
            
            echo "::group::üîÑ Executing Proxy: $RAW_NAME"
            
            # GitLab'a stat√º bas (Encoded Name ile)
            API_URL="${{ github.event.inputs.gitlab_url }}/api/v4/projects/${{ github.event.inputs.project_id }}/statuses/${{ github.event.inputs.sha }}"
            curl --request POST --header "PRIVATE-TOKEN: ${{ secrets.GL_BRIDGE_TOKEN }}" \
            "$API_URL?state=running&context=Shadow-Runner/$ENC_NAME"

            # 1. Env Variables
            eval $(yq e '.env | to_entries | .[] | "export " + .key + "=\"" + .value + "\""' "$WF_PATH" 2>/dev/null || true)
            eval $(yq e '.jobs.*.env | to_entries | .[] | "export " + .key + "=\"" + .value + "\""' "$WF_PATH" 2>/dev/null || true)
            
            # 2. Dependencies
            if [ -f "package.json" ]; then npm install; fi
            if [ -f "composer.json" ]; then composer install; fi

            # 3. Steps Execution
            yq e '.jobs.*.steps[] | select(has("run")) | .run' "$WF_PATH" | while read -r cmd; do
              if [ "$cmd" != "null" ] && [ -n "$cmd" ]; then
                echo "‚ñ∂Ô∏è EXEC: $cmd"
                eval "$cmd"
              fi
            done
            
            echo "::endgroup::"
          done

      - name: Final Result
        if: always()
        run: |
          STATE="success"
          if [[ "${{ job.status }}" != "success" ]]; then STATE="failed"; fi
          
          # Bo≈üluklarƒ± %20 yapƒ±yoruz (Url Safe)
          DESC=$(python3 -c "import urllib.parse; print(urllib.parse.quote('Shadow Envoy finished with status: ${{ job.status }}'))")
          
          API_URL="${{ github.event.inputs.gitlab_url }}/api/v4/projects/${{ github.event.inputs.project_id }}/statuses/${{ github.event.inputs.sha }}"
          curl --request POST --header "PRIVATE-TOKEN: ${{ secrets.GL_BRIDGE_TOKEN }}" \
          "$API_URL?state=$STATE&context=Shadow-Runner/Final&description=$DESC"
