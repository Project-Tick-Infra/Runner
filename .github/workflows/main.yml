name: Shadow Bridge Runner
on: 
  workflow_dispatch:
    inputs:
      project_id: { required: true }
      project_full_name: { required: true }
      branch: { required: true }
      sha: { required: true }
      gitlab_url: { required: true }

jobs:
  shadow-runner:
    runs-on: ubuntu-latest
    steps:
      - name: "üîç Validate Secrets"
        run: |
          if [ -z "${{ secrets.GL_BRIDGE_TOKEN }}" ]; then
            echo "‚ùå ERROR: GL_BRIDGE_TOKEN is missing in GitHub Secrets!"
            exit 1
          fi

      - name: "Status: Initializing Shadow Connection"
        run: |
          GITLAB_API_URL="${{ github.event.inputs.gitlab_url }}/api/v4/projects/${{ github.event.inputs.project_id }}/statuses/${{ github.event.inputs.sha }}"
          curl --request POST --header "PRIVATE-TOKEN: ${{ secrets.GL_BRIDGE_TOKEN }}" \
          "$GITLAB_API_URL?state=running&context=Shadow-Runner/Init"

      - name: Fetch Code
        run: |
          git clone --branch ${{ github.event.inputs.branch }} \
          https://oauth2:${{ secrets.GL_BRIDGE_TOKEN }}@git.projecttick.org/${{ github.event.inputs.project_full_name }}.git .

      - name: üïµÔ∏è‚Äç‚ôÇÔ∏è Discover PR Workflows
        id: filter
        run: |
          mkdir -p .github/workflows
          FILES=$(ls .github/workflows/*.{yml,yaml} 2>/dev/null || echo "")
          FOUND_WF=""
          
          for f in $FILES; do
             # Daha basit ve hata payƒ± d√º≈ü√ºk bir kontrol:
             # Dosyanƒ±n 'on' kƒ±smƒ±nda 'pull_request' ge√ßiyor mu?
             IS_PR=$(yq e '.on' "$f" 2>/dev/null | grep -qi "pull_request" && echo "1" || echo "0")
             
             if [ "$IS_PR" == "1" ]; then
                echo "‚úÖ Match Found: $f"
                FILENAME=$(basename "$f")
                FOUND_WF="$FOUND_WF $FILENAME"
             fi
          done
          
          CLEAN_FOUND=$(echo $FOUND_WF | xargs)
          echo "selected_workflows=$CLEAN_FOUND" >> $GITHUB_OUTPUT
          echo "Found: $CLEAN_FOUND"

      - name: üöÄ Proxy Execution (Sequential Reusable Style)
        if: steps.filter.outputs.selected_workflows != ''
        shell: bash
        run: |
          set -e
          
          # Bo≈ülukla ayrƒ±lmƒ±≈ü listeyi diziye √ßevir
          WORKFLOWS=(${{ steps.filter.outputs.selected_workflows }})
          
          for WF in "${WORKFLOWS[@]}"; do
            WF_PATH=".github/workflows/$WF"
            WF_NAME=$(yq e '.name // "'$WF'"' "$WF_PATH")
            
            echo "::group::üîÑ Executing Proxy: $WF_NAME"
            
            # GitLab'a stat√º bas
            curl --request POST --header "PRIVATE-TOKEN: ${{ secrets.GL_BRIDGE_TOKEN }}" \
            "${{ github.event.inputs.gitlab_url }}/api/v4/projects/${{ github.event.inputs.project_id }}/statuses/${{ github.event.inputs.sha }}?state=running&context=Shadow-Runner/$WF_NAME"

            # 1. Env'leri Bind Et
            EXPORT_CMD=$(yq e '.env | to_entries | .[] | "export " + .key + "=\"" + .value + "\""' "$WF_PATH" 2>/dev/null || true)
            if [ -n "$EXPORT_CMD" ]; then eval "$EXPORT_CMD"; fi
            
            # 2. Ortamƒ± Hazƒ±rla
            if [ -f "package.json" ]; then npm install; fi
            if [ -f "composer.json" ]; then composer install; fi

            # 3. Native Adƒ±mlarƒ± Ko≈ütur
            yq e '.jobs.*.steps[] | select(has("run")) | .run' "$WF_PATH" | while read -r cmd; do
              if [ "$cmd" != "null" ] && [ -n "$cmd" ]; then
                echo "----------------------------------------"
                echo "‚ñ∂Ô∏è EXEC: $cmd"
                eval "$cmd"
              fi
            done
            
            echo "::endgroup::"
          done

      - name: Final Result
        if: always()
        run: |
          STATE="success"
          if [[ "${{ job.status }}" != "success" ]]; then STATE="failed"; fi
          
          curl --request POST --header "PRIVATE-TOKEN: ${{ secrets.GL_BRIDGE_TOKEN }}" \
          "${{ github.event.inputs.gitlab_url }}/api/v4/projects/${{ github.event.inputs.project_id }}/statuses/${{ github.event.inputs.sha }}?state=$STATE&context=Shadow-Runner/Final&description=Shadow Envoy finished."
