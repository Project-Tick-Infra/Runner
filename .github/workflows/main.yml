name: Shadow Bridge Runner
on: 
  workflow_dispatch:
    inputs:
      project_id: { required: true }
      project_full_name: { required: true }
      branch: { required: true }
      sha: { required: true }
      gitlab_url: { required: true }

jobs:
  shadow-runner:
    runs-on: ubuntu-latest
    steps:
      - name: "Status: Initializing Shadow Envoy"
        run: |
          if [ -z "${{ secrets.GL_BRIDGE_TOKEN }}" ]; then
            echo "::error::GL_BRIDGE_TOKEN is MISSING! Please add it to GitHub Secrets."
            exit 1
          fi
          # GitLab API URL'ini hazƒ±rlayalƒ±m
          URL="${{ github.event.inputs.gitlab_url }}/api/v4/projects/${{ github.event.inputs.project_id }}/statuses/${{ github.event.inputs.sha }}"
          curl --request POST --header "PRIVATE-TOKEN: ${{ secrets.GL_BRIDGE_TOKEN }}" \
          "$URL?state=running&context=Shadow-Runner/Handshake"

      - name: Fetch Code
        run: |
          git clone --branch ${{ github.event.inputs.branch }} \
          https://oauth2:${{ secrets.GL_BRIDGE_TOKEN }}@git.projecttick.org/${{ github.event.inputs.project_full_name }}.git .

      - name: üïµÔ∏è‚Äç‚ôÇÔ∏è Discover PR Workflows
        id: filter
        run: |
          mkdir -p .github/workflows
          FILES=$(ls .github/workflows/*.{yml,yaml} 2>/dev/null || echo "")
          FOUND=""
          
          for f in $FILES; do
             # Sadece i√ßinde pull_request ge√ßenleri alƒ±yoruz (Daha basit ve saƒülam kontrol)
             if grep -qi "pull_request" "$f"; then
                echo "‚úÖ Native Workflow Detected: $f"
                FOUND="$FOUND $(basename "$f")"
             fi
          done
          
          echo "selected_workflows=$(echo $FOUND | xargs)" >> $GITHUB_OUTPUT

      - name: üöÄ Execute Proxy (The Hard Way)
        if: steps.filter.outputs.selected_workflows != ''
        shell: bash
        run: |
          set -e
          WORKFLOWS=(${{ steps.filter.outputs.selected_workflows }})
          
          for WF in "${WORKFLOWS[@]}"; do
            WF_PATH=".github/workflows/$WF"
            WF_NAME=$(yq e '.name // "'$WF'"' "$WF_PATH")
            
            # URL Encoding Fix (Daha g√ºvenli y√∂ntem)
            ENC_NAME=$(python3 -c "import urllib.parse, sys; print(urllib.parse.quote(sys.argv[1]))" "$WF_NAME")
            
            echo "::group::üîÑ Proxying Native Workflow: $WF_NAME"
            
            # GitLab Status: Running
            curl --request POST --header "PRIVATE-TOKEN: ${{ secrets.GL_BRIDGE_TOKEN }}" \
            "${{ github.event.inputs.gitlab_url }}/api/v4/projects/${{ github.event.inputs.project_id }}/statuses/${{ github.event.inputs.sha }}?state=running&context=Shadow-Runner/$ENC_NAME"

            # 1. ENVs (Global & Job)
            eval $(yq e '.env | to_entries | .[] | "export " + .key + "=\"" + .value + "\""' "$WF_PATH" 2>/dev/null || true)
            eval $(yq e '.jobs.*.env | to_entries | .[] | "export " + .key + "=\"" + .value + "\""' "$WF_PATH" 2>/dev/null || true)
            
            # 2. Dependencies
            if [ -f "package.json" ]; then npm install; fi
            if [ -f "composer.json" ]; then composer install; fi

            # 3. Dynamic Step Execution (Real Eval)
            # Workflow'un asƒ±l komutlarƒ±nƒ± buradaki shell'e basƒ±yoruz
            yq e '.jobs.*.steps[] | select(has("run")) | .run' "$WF_PATH" | while read -r cmd; do
              if [ "$cmd" != "null" ] && [ -n "$cmd" ]; then
                echo "‚ñ∂Ô∏è Running Native Step..."
                eval "$cmd"
              fi
            done
            
            echo "::endgroup::"
          done

      - name: Final Success Report
        if: success()
        run: |
          DESC=$(python3 -c "import urllib.parse; print(urllib.parse.quote('Shadow Envoy: All native steps completed.'))")
          curl --request POST --header "PRIVATE-TOKEN: ${{ secrets.GL_BRIDGE_TOKEN }}" \
          "${{ github.event.inputs.gitlab_url }}/api/v4/projects/${{ github.event.inputs.project_id }}/statuses/${{ github.event.inputs.sha }}?state=success&context=Shadow-Runner/Final&description=$DESC"

      - name: Final Failure Report
        if: failure()
        run: |
          DESC=$(python3 -c "import urllib.parse; print(urllib.parse.quote('Shadow Envoy: A native step has failed.'))")
          curl --request POST --header "PRIVATE-TOKEN: ${{ secrets.GL_BRIDGE_TOKEN }}" \
          "${{ github.event.inputs.gitlab_url }}/api/v4/projects/${{ github.event.inputs.project_id }}/statuses/${{ github.event.inputs.sha }}?state=failed&context=Shadow-Runner/Final&description=$DESC"
