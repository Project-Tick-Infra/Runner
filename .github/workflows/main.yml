name: Shadow Bridge Runner
on: 
  workflow_dispatch:
    inputs:
      project_id: { required: true }
      project_full_name: { required: true }
      branch: { required: true }
      sha: { required: true }
      gitlab_url: { required: true }

jobs:
  shadow-runner:
    runs-on: ubuntu-latest
    steps:
      - name: "Status: Initializing Shadow Connection"
        run: |
          # GitLab URL'sinin boÅŸ gelmediÄŸinden emin olalÄ±m
          GITLAB_API_URL="${{ github.event.inputs.gitlab_url }}/api/v4/projects/${{ github.event.inputs.project_id }}/statuses/${{ github.event.inputs.sha }}"
          curl --request POST --header "PRIVATE-TOKEN: ${{ secrets.GL_BRIDGE_TOKEN }}" \
          "$GITLAB_API_URL?state=running&context=Shadow-Runner/Init"

      - name: Fetch Code
        run: |
          # Kodu Ã§ekiyoruz
          git clone --branch ${{ github.event.inputs.branch }} \
          https://oauth2:${{ secrets.GL_BRIDGE_TOKEN }}@git.projecttick.org/${{ github.event.inputs.project_full_name }}.git .

      - name: ðŸ•µï¸â€â™‚ï¸ Discover Pull Request Workflows
        id: filter
        run: |
          mkdir -p .github/workflows
          FILES=$(ls .github/workflows/*.{yml,yaml} 2>/dev/null || echo "")
          FOUND=""
          
          for f in $FILES; do
             # Daha saÄŸlam bir pull_request kontrolÃ¼ (yq ile 'on' bloÄŸunu tarar)
             IS_PR=$(yq e '.on | (.. | select(. == "pull_request"))' "$f" 2>/dev/null | grep -c "pull_request" || echo "0")
             
             if [ "$IS_PR" -gt 0 ]; then
                echo "âœ… Match Found: $f"
                FOUND="$FOUND $f"
             fi
          done
          
          # Sondaki ve baÅŸtaki boÅŸluklarÄ± temizle
          FOUND=$(echo $FOUND | xargs)
          echo "selected_workflows=$FOUND" >> $GITHUB_OUTPUT
          echo "Found Workflows: $FOUND"

      - name: ðŸš€ Reusable-Style Execution
        if: steps.filter.outputs.selected_workflows != ''
        shell: bash
        run: |
          # Hata yÃ¶netimini sÄ±kÄ±laÅŸtÄ±rÄ±yoruz
          set -e
          
          for WF_PATH in ${{ steps.filter.outputs.selected_workflows }}; do
            WF_NAME=$(yq e '.name // "'$WF_PATH'"' "$WF_PATH")
            
            echo "::group::ðŸ”„ Calling Reusable Proxy: $WF_NAME"
            
            # GitLab'a "Bu spesifik iÅŸ baÅŸladÄ±" diyelillm
            curl --request POST --header "PRIVATE-TOKEN: ${{ secrets.GL_BRIDGE_TOKEN }}" \
            "${{ github.event.inputs.gitlab_url }}/api/v4/projects/${{ github.event.inputs.project_id }}/statuses/${{ github.event.inputs.sha }}?state=running&context=Shadow-Runner/$WF_NAME"

            # Env Variables (Sanki Reusable iÃ§indeymiÅŸiz gibi yÃ¼kle)
            EXPORT_ENV=$(yq e '.env | to_entries | .[] | "export " + .key + "=\"" + .value + "\""' "$WF_PATH" 2>/dev/null || true)
            if [ -n "$EXPORT_ENV" ]; then eval "$EXPORT_ENV"; fi
            
            # BaÄŸÄ±mlÄ±lÄ±klar (Her workflow Ã¶ncesi temiz baÅŸlangÄ±Ã§)
            if [ -f "package.json" ]; then npm install; fi
            if [ -f "composer.json" ]; then composer install; fi

            # AdÄ±mlarÄ± koÅŸtur (Sadece 'run' iÃ§erenleri alÄ±yoruz)
            # Reusable hissiyatÄ± iÃ§in her step'i ayrÄ± ayrÄ± logluyoruz
            yq e '.jobs.*.steps[] | select(has("run")) | .run' "$WF_PATH" | while read -r cmd; do
              if [ "$cmd" != "null" ] && [ -n "$cmd" ]; then
                echo "---> Action Step: $cmd"
                eval "$cmd"
              fi
            done
            
            echo "::endgroup::"
          done

      - name: Final Success Report
        if: success()
        run: |
          curl --request POST --header "PRIVATE-TOKEN: ${{ secrets.GL_BRIDGE_TOKEN }}" \
          "${{ github.event.inputs.gitlab_url }}/api/v4/projects/${{ github.event.inputs.project_id }}/statuses/${{ github.event.inputs.sha }}?state=success&context=Shadow-Runner/Final&description=All native PR workflows successfully proxied."

      - name: Final Failure Report
        if: failure()
        run: |
          curl --request POST --header "PRIVATE-TOKEN: ${{ secrets.GL_BRIDGE_TOKEN }}" \
          "${{ github.event.inputs.gitlab_url }}/api/v4/projects/${{ github.event.inputs.project_id }}/statuses/${{ github.event.inputs.sha }}?state=failed&context=Shadow-Runner/Final&description=Workflow Proxy failed. Check logs."
