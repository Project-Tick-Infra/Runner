name: Shadow Bridge Runner
on: 
  workflow_dispatch:
    inputs:
      project_id: { required: true }
      project_full_name: { required: true }
      branch: { required: true }
      sha: { required: true }
      gitlab_url: { required: true }

jobs:
  shadow-runner:
    runs-on: ubuntu-latest
    steps:
      - name: "Status: Initializing Shadow Realm"
        run: |
          curl --request POST --header "PRIVATE-TOKEN: ${{ secrets.GL_BRIDGE_TOKEN }}" \
          "${{ github.event.inputs.gitlab_url }}/api/v4/projects/${{ github.event.inputs.project_id }}/statuses/${{ github.event.inputs.sha }}?state=running&context=Shadow-Runner/Init"

      - name: Fetch Code
        run: |
          git clone --branch ${{ github.event.inputs.branch }} \
          https://oauth2:${{ secrets.GL_BRIDGE_TOKEN }}@git.projecttick.org/${{ github.event.inputs.project_full_name }}.git .

      - name: ï¿½ï¸â€â™‚ï¸ Discover & Filter Workflows (pull_request only)
        id: filter
        run: |
          # Sadece 'on' kÄ±smÄ±nda 'pull_request' olan dosyalarÄ± buluyoruz
          mkdir -p .github/workflows
          FILES=$(ls .github/workflows/*.{yml,yaml} 2>/dev/null || echo "")
          FOUND=""
          
          for f in $FILES; do
             # YQ ile 'on' kÄ±smÄ±nda pull_request var mÄ± diye kesin kontrol yapÄ±yoruz
             if yq e '.on | (.. | select(tag == "!!str") == "pull_request") or has("pull_request")' "$f" | grep -q "true"; then
                FOUND="$FOUND $f"
             fi
          done
          
          echo "selected_workflows=$FOUND" >> $GITHUB_OUTPUT
          echo "Found: $FOUND"

      - name: ğŸš€ Reusable Execution (Eval Mode)
        if: steps.filter.outputs.selected_workflows != ''
        shell: bash
        run: |
          # Hata durumunda dÃ¶ngÃ¼den Ã§Ä±kmak iÃ§in set -e
          set -e
          
          for WF_PATH in ${{ steps.filter.outputs.selected_workflows }}; do
            WF_NAME=$(yq e '.name // "'$WF_PATH'"' "$WF_PATH")
            echo "::group::Executing Workflow: $WF_NAME"
            
            # 1. Bildirim: Bu workflow baÅŸlÄ±yor
            curl --request POST --header "PRIVATE-TOKEN: ${{ secrets.GL_BRIDGE_TOKEN }}" \
            "${{ github.event.inputs.gitlab_url }}/api/v4/projects/${{ github.event.inputs.project_id }}/statuses/${{ github.event.inputs.sha }}?state=running&context=Shadow-Runner/$WF_NAME"

            # 2. Env'leri Bind et (Global & Job seviyesi)
            # Not: Hata payÄ±nÄ± azaltmak iÃ§in try-catch benzeri yapÄ±
            GLOBAL_ENV=$(yq e '.env | to_entries | .[] | "export " + .key + "=\"" + .value + "\""' "$WF_PATH" 2>/dev/null || true)
            if [ -n "$GLOBAL_ENV" ]; then eval "$GLOBAL_ENV"; fi
            
            JOB_ENV=$(yq e '.jobs.*.env | to_entries | .[] | "export " + .key + "=\"" + .value + "\""' "$WF_PATH" 2>/dev/null || true)
            if [ -n "$JOB_ENV" ]; then eval "$JOB_ENV"; fi

            # 3. BaÄŸÄ±mlÄ±lÄ±klar (Opsiyonel ama faydalÄ±)
            if [ -f "package.json" ]; then npm install; fi
            if [ -f "composer.json" ]; then composer install; fi

            # 4. AdÄ±mlarÄ± Eval et
            # Sadece 'run' iÃ§eren adÄ±mlarÄ± sÄ±rayla koÅŸturur
            yq e '.jobs.*.steps[] | select(has("run")) | .run' "$WF_PATH" | while read -r script; do
              if [ "$script" != "null" ]; then
                echo "----------------------------------------"
                echo "â–¶ï¸ Step: $script"
                eval "$script"
                if [ $? -ne 0 ]; then
                  echo "âŒ FAILED step in $WF_NAME"
                  exit 1
                fi
              fi
            done
            
            echo "::endgroup::"
          done

      - name: Final Success Report
        if: success()
        run: |
          curl --request POST --header "PRIVATE-TOKEN: ${{ secrets.GL_BRIDGE_TOKEN }}" \
          "${{ github.event.inputs.gitlab_url }}/api/v4/projects/${{ github.event.inputs.project_id }}/statuses/${{ github.event.inputs.sha }}?state=success&context=Shadow-Runner/Final&description=All native pull_request workflows passed!"

      - name: Final Failure Report
        if: failure()
        run: |
          curl --request POST --header "PRIVATE-TOKEN: ${{ secrets.GL_BRIDGE_TOKEN }}" \
          "${{ github.event.inputs.gitlab_url }}/api/v4/projects/${{ github.event.inputs.project_id }}/statuses/${{ github.event.inputs.sha }}?state=failed&context=Shadow-Runner/Final&description=One or more workflows failed in eval mode."
