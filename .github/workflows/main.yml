name: Shadow Bridge Runner
on: 
  workflow_dispatch:
    inputs:
      project_id: { required: true }
      project_full_name: { required: true }
      branch: { required: true }
      sha: { required: true }
      gitlab_url: { required: true }

permissions:
  contents: write
  statuses: write

jobs:
  relay:
    runs-on: ubuntu-latest
    steps:
      - name: "üîç Validate Secrets"
        run: |
          if [ -z "${{ secrets.GH_BRIDGE_TOKEN }}" ]; then
            echo "‚ùå ERROR: GH_BRIDGE_TOKEN is MISSING in GitHub Secrets!"
            echo "You MUST add your GitHub PAT to Secrets with 'workflow' scope."
            exit 1
          fi

      - name: "Status: Cloning & Mirroring"
        run: |
          URL="${{ github.event.inputs.gitlab_url }}/api/v4/projects/${{ github.event.inputs.project_id }}/statuses/${{ github.event.inputs.sha }}"
          curl --request POST --header "PRIVATE-TOKEN: ${{ secrets.GL_BRIDGE_TOKEN }}" \
          "$URL?state=running&context=Shadow-Runner/Relay"

      - name: Fetch Code from GitLab
        run: |
          git clone --branch ${{ github.event.inputs.branch }} \
          https://oauth2:${{ secrets.GL_BRIDGE_TOKEN }}@git.projecttick.org/${{ github.event.inputs.project_full_name }}.git .

      - name: üöÄ Push to Shadow Mirror (using PAT)
        run: |
          git config user.name "Shadow Runner"
          git config user.email "runner@projecttick.org"
          
          # Branch adƒ±nƒ± belirle
          BRANCH_NAME="shadow/${{ github.event.inputs.project_id }}/${{ github.event.inputs.sha }}"
          
          # BURASI KRƒ∞Tƒ∞K: GITHUB_TOKEN yerine senin GH_BRIDGE_TOKEN pat'ini kullanƒ±yoruz!
          # B√∂ylece .github/workflows dosyalarƒ±nƒ± pushlamamƒ±za izin verecek.
          git remote add shadow-origin https://x-access-token:${{ secrets.GH_BRIDGE_TOKEN }}@github.com/${{ github.repository }}.git
          
          git push -f shadow-origin HEAD:refs/heads/$BRANCH_NAME
          
          echo "‚úÖ Code pushed to $BRANCH_NAME. Native CI will trigger now!"

      - name: Final Success Report
        if: success()
        run: |
          URL="${{ github.event.inputs.gitlab_url }}/api/v4/projects/${{ github.event.inputs.project_id }}/statuses/${{ github.event.inputs.sha }}"
          curl --request POST --header "PRIVATE-TOKEN: ${{ secrets.GL_BRIDGE_TOKEN }}" \
          "$URL?state=success&context=Shadow-Runner/Relay&description=Mirror%20Triggered%20Successfully"
