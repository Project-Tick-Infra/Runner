name: Shadow Bridge Runner
on: 
  workflow_dispatch:
    inputs:
      project_id: { required: true }
      project_full_name: { required: true }
      branch: { required: true }
      sha: { required: true }
      gitlab_url: { required: true }

jobs:
  # 1. ADIM: Kodu HazÄ±rla ve Pushla (ArtÄ±k EVAL yok, REAL TRIGGER var)
  relay:
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ” Validate Token"
        run: |
          if [ -z "${{ secrets.GL_BRIDGE_TOKEN }}" ]; then
            echo "âŒ ERROR: GL_BRIDGE_TOKEN is MISSING! Add it to GitHub Secrets."
            exit 1
          fi

      - name: "Status: Cloning & Mirroring"
        run: |
          URL="${{ github.event.inputs.gitlab_url }}/api/v4/projects/${{ github.event.inputs.project_id }}/statuses/${{ github.event.inputs.sha }}"
          curl --request POST --header "PRIVATE-TOKEN: ${{ secrets.GL_BRIDGE_TOKEN }}" \
          "$URL?state=running&context=Shadow-Runner/Relay"

      - name: Fetch Code
        run: |
          # Kodu GitLab'dan Ã§ek
          git clone --branch ${{ github.event.inputs.branch }} \
          https://oauth2:${{ secrets.GL_BRIDGE_TOKEN }}@git.projecttick.org/${{ github.event.inputs.project_full_name }}.git .

      - name: ï¿½ Push to Shadow Mirror Branch
        run: |
          # Bu adÄ±m, kodu GitHub'daki bu reponun bir branch'ine pushlar.
          # BÃ¶ylece GitHub, o branch'teki .github/workflows/*.yml dosyalarÄ±nÄ± NATIVE olarak Ã§alÄ±ÅŸtÄ±rÄ±r.
          # Ä°ÅŸte 'uses' ve 'matrix' bu ÅŸekilde Ã§alÄ±ÅŸÄ±r.
          
          git config user.name "Shadow Runner"
          git config user.email "runner@projecttick.org"
          
          # GeÃ§ici bir branch adÄ± oluÅŸtur (Shadow/SHA)
          BRANCH_NAME="shadow/${{ github.event.inputs.project_id }}/${{ github.event.inputs.sha }}"
          
          # GitHub reposuna uzaktan baÄŸlan ve pushla
          git remote add shadow https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push -f shadow HEAD:refs/heads/$BRANCH_NAME
          
          echo "âœ… Code pushed to branch $BRANCH_NAME. Native workflows will ahora trigger!"

      - name: Final Success Report
        run: |
          URL="${{ github.event.inputs.gitlab_url }}/api/v4/projects/${{ github.event.inputs.project_id }}/statuses/${{ github.event.inputs.sha }}"
          curl --request POST --header "PRIVATE-TOKEN: ${{ secrets.GL_BRIDGE_TOKEN }}" \
          "$URL?state=success&context=Shadow-Runner/Relay&description=Mirror%20Triggered%20Successfully"
