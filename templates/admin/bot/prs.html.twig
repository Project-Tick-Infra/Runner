{% extends 'base.html.twig' %}

{% block title %}Pull Requests | Automation Hub{% endblock %}

{% block body %}
<div class="py-5" style="max-width: 1200px; margin: 0 auto; padding: 0 20px;">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 40px;">
        <div>
            <h1>All <span style="color:#EE0000">Pull Requests</span></h1>
            <p>Recent activity across all Project Tick repositories.</p>
        </div>
        <a href="{{ path('app_admin_bot_index') }}" class="btn btn-secondary">&larr; Back to Hub</a>
    </div>

    <div class="table-container" style="background: white; border-radius: 20px; border: 1px solid #eee; overflow: hidden;">
        <table class="table" style="width: 100%; border-collapse: collapse;">
            <thead style="background: #fafafa; border-bottom: 2px solid #eee;">
                <tr>
                    <th style="text-align: left; padding: 20px;">Repository</th>
                    <th style="text-align: left; padding: 20px;">PR</th>
                    <th style="text-align: left; padding: 20px;">Author</th>
                    <th style="text-align: left; padding: 20px;">Status</th>
                    <th style="text-align: left; padding: 20px;">Created</th>
                </tr>
            </thead>
            <tbody>
                {% for pr in prs %}
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 20px;">
                        <span style="background: #f0f0f0; padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: bold;">
                            {{ pr.repository }}
                        </span>
                    </td>
                    <td style="padding: 20px;">
                        <a href="{{ pr.htmlUrl }}" target="_blank" style="font-weight: bold; text-decoration: none; color: inherit; display: block; margin-bottom: 5px;">
                            #{{ pr.number }}: {{ pr.title }}
                        </a>
                        <div style="font-size: 0.8rem; color: #666; margin-bottom: 10px; max-height: 40px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                            {{ pr.body|striptags }}
                        </div>
                        <div style="margin-top: 5px; display: flex; flex-wrap: wrap; gap: 5px;">
                            {% for label in pr.labels %}
                            <span style="font-size: 0.7rem; color: #666; border: 1px solid #ddd; padding: 2px 6px; border-radius: 10px;">{{ label }}</span>
                            {% endfor %}
                        </div>

                        {% if pr.commits|length > 0 %}
                        <div style="margin-top: 15px; background: #fafafa; border-radius: 8px; padding: 12px;">
                            <div style="font-size: 0.75rem; font-weight: 800; color: #999; margin-bottom: 8px; text-transform: uppercase;">Recent Commits ({{ pr.commits|length }})</div>
                            {% for commit in pr.commits|slice(0, 3) %}
                            <div style="font-size: 0.8rem; margin-bottom: 4px; display: flex; align-items: baseline; gap: 10px;">
                                <code style="font-size: 0.7rem; color: var(--pt-red); background: #fff; padding: 2px 4px; border: 1px solid #eee;">{{ commit.sha|slice(0, 7) }}</code>
                                <span style="color: #444;">{{ commit.message|split('\n')|first }}</span>
                            </div>
                            {% endfor %}
                            {% if pr.commits|length > 3 %}
                            <div style="font-size: 0.75rem; color: #999; font-style: italic;">+ {{ pr.commits|length - 3 }} more commits</div>
                            {% endif %}
                        </div>
                        {% endif %}

                        {% if pr.diff %}
                        <div style="margin-top: 15px;">
                            <button onclick="toggleDiff('diff-{{ pr.id }}')" class="btn btn-secondary" style="padding: 6px 15px; font-size: 0.75rem; border: 1px solid #ddd; background: #fff;">VIEW RAW DIFF</button>
                            <div id="diff-{{ pr.id }}" style="display: none; margin-top: 10px; background: #0D1117; color: #E6EDF3; padding: 15px; border-radius: 10px; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; max-height: 300px; overflow: auto; white-space: pre;">{{ pr.diff }}</div>
                        </div>
                        {% endif %}
                    </td>
                    <td style="padding: 20px; font-weight: 500;">@{{ pr.author }}</td>
                    <td style="padding: 20px;">
                        <span style="background: {% if pr.state == 'open' %}#E7F4E4{% elseif pr.state == 'closed' %}#FDF2F2{% else %}#eee{% endif %}; color: {% if pr.state == 'open' %}#1B5E20{% elseif pr.state == 'closed' %}#B71C1C{% else %}#666{% endif %}; padding: 4px 12px; border-radius: 40px; font-size: 0.75rem; font-weight: 900; text-transform: uppercase;">
                            {{ pr.state }}
                        </span>
                    </td>
                    <td style="padding: 20px; color: #999; font-size: 0.85rem;">{{ pr.createdAt|date('Y-m-d H:i') }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" style="padding: 40px; text-align: center; color: #999;">No PRs tracked yet. Run a scan to sync.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div style="margin-top: 40px;">
        <a href="{{ path('app_admin_bot_index') }}" class="btn btn-secondary" style="background: transparent; border: 1px solid #eee; padding: 10px 20px; border-radius: 10px; text-decoration: none; color: #666;">&larr; Back to Hub</a>
    </div>
</div>

<script>
function toggleDiff(id) {
    const el = document.getElementById(id);
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
}
</script>
{% endblock %}
