{% extends 'base.html.twig' %}

{% block title %}Admin Dashboard{% endblock %}

{% block body %}
<div class="py-5">
    <div class="admin-header">
        <h1>Admin Panel <span class="admin-breadcrumb">/ Overview</span></h1>
        <div style="display: flex; gap: 10px; align-items: center;">
            <span class="badge" style="background: #333; color: #eee; font-family: monospace; font-size: 0.8rem; padding: 4px 10px; border-radius: 4px;">v{{ version }}</span>
            {% if license_info.type in ['PRO', 'ENTERPRISE', 'SAAS', 'OFFICIAL'] %}
                <span class="badge" style="background: #2E7D32; color: white; font-size: 0.75rem; padding: 4px 10px; border-radius: 4px;">COMMERCIAL / {{ license_info.type }}</span>
            {% else %}
                <span class="badge" style="background: #1976D2; color: white; font-size: 0.75rem; padding: 4px 10px; border-radius: 4px;">COMMUNITY EDITION</span>
            {% endif %}
        </div>
    </div>

    {% if license_info.status == 'VERIFIED' %}
        <div class="alert alert-success mt-3" style="background: rgba(46, 125, 50, 0.1); border: 1px solid #2E7D32; border-radius: 6px; padding: 12px 16px; color: #1b5e20;">
            <strong><i class="fas fa-check-circle"></i> License Verified:</strong> {{ license_info.payload }}
            <span style="float:right; opacity:0.8; font-size: 0.85em;">Type: {{ license_info.type }} | Expires: {{ license_info.year }}</span>
        </div>
    {% elseif license_info.status == 'OFFICIAL_INFRA' %}
        <div class="alert alert-info mt-3" style="background: rgba(25, 118, 210, 0.1); border: 1px solid #1976D2; border-radius: 6px; padding: 12px 16px; color: #0d47a1;">
            <strong><i class="fas fa-server"></i> Verified Infrastructure:</strong> Running on Official Project Tick Server.
        </div>
    {% elseif license_info.status == 'COMMUNITY_MODE' or license_info.type == 'COMMUNITY' %}
        <div class="alert alert-secondary mt-3" style="background: rgba(25, 118, 210, 0.1); border: 1px solid #1976D2; border-radius: 6px; padding: 12px 16px; color: #0d47a1;">
            <strong style="font-size: 1.1em;"><i class="fas fa-users"></i> Project Tick Community Edition</strong>
            <p style="margin: 8px 0 0 0; font-size: 0.9em;">You are running the free and open-source edition. Advanced modules (GitLab Bridge, Legal CLA Check, Uptime Monitor) are currently restricted. To unlock Enterprise tools, you need a valid RSA-signed <a href="https://projecttick.org" target="_blank" style="color: #0d47a1; text-decoration: underline;">Commercial License Key</a>.</p>
        </div>
    {% elseif license_info.status == 'DEV_MODE' %}
        <div class="alert alert-warning mt-3" style="background: rgba(255, 152, 0, 0.1); border: 1px solid #FF9800; border-radius: 6px; padding: 12px 16px; color: #e65100;">
            <strong><i class="fas fa-code"></i> Developer Mode:</strong> License checks bypassed.
        </div>
    {% else %}
        <div class="alert alert-danger mt-3" style="background: rgba(182, 2, 5, 0.1); border: 1px solid #B60205; border-radius: 6px; padding: 12px 16px; color: #b71c1c;">
            <strong><i class="fas fa-exclamation-triangle"></i> License Error:</strong> {{ license_info.status|replace({'_': ' '})|title }}
        </div>
    {% endif %}

    {# Statistics Row #}
    <div class="admin-grid mt-4" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));">
        <div class="card" style="border-bottom: 4px solid var(--pt-red); text-align: center;">
            <p style="text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.1em; color: #666; margin-bottom: 8px;">Total Traffic</p>
            <h2 style="font-size: 2.5rem; margin: 0;">{{ total_visits }}</h2>
            <p style="font-size: 0.85rem; color: #888; margin-top: 8px;">Life-time page views</p>
        </div>
        <div class="card" style="border-bottom: 4px solid #2E7D32; text-align: center;">
            <p style="text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.1em; color: #666; margin-bottom: 8px;">Last 24 Hours</p>
            <h2 style="font-size: 2.5rem; margin: 0;">{{ recent_visits }}</h2>
            <p style="font-size: 0.85rem; color: #888; margin-top: 8px;">Unique session traffic</p>
        </div>
        <div class="card" style="border-bottom: 4px solid #1976D2; text-align: center;">
            <p style="text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.1em; color: #666; margin-bottom: 8px;">News & Handbook</p>
            <h2 style="font-size: 2.5rem; margin: 0;">{{ news_count + handbook_count }}</h2>
            <p style="font-size: 0.85rem; color: #888; margin-top: 8px;">Total content items</p>
        </div>
    </div>

    {# Module Status Row #}
    <div class="admin-header mt-5">
        <h2>Module Status</h2>
    </div>
    <div class="admin-grid mt-3" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
        {% for name, enabled in modules %}
            <div class="card" style="padding: 16px; border-left: 4px solid {{ enabled ? '#2E7D32' : '#B60205' }}; background: {{ enabled ? 'rgba(46, 125, 50, 0.02)' : 'rgba(182, 2, 5, 0.02)' }};">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <span style="font-weight: 600; text-transform: capitalize;">{{ name|replace({'_': ' '}) }}</span>
                    <span class="badge {{ enabled ? 'badge-success' : 'badge-danger' }}" style="background: {{ enabled ? '#2E7D32' : '#B60205' }}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem;">
                        {{ enabled ? 'Active' : 'Disabled' }}
                    </span>
                </div>
            </div>
        {% endfor %}
    </div>

    <div class="grid mt-4" style="grid-template-columns: 1fr 1fr; gap: 24px;">
        {# OS Distribution #}
        <div class="card">
            <h3>Operating Systems</h3>
            <div style="margin-top: 16px;">
                {% for stat in os_stats %}
                    <div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 4px;">
                            <span>{{ stat.os }}</span>
                            <span>{{ stat.count }}</span>
                        </div>
                        <div style="height: 8px; background: #eee; border-radius: 4px; overflow: hidden;">
                            <div style="width: {{ (stat.count / total_visits * 100)|round }}%; height: 100%; background: var(--pt-red);"></div>
                        </div>
                    </div>
                {% else %}
                    <p>No data yet.</p>
                {% endfor %}
            </div>
        </div>
        {# Browser Distribution #}
        <div class="card">
            <h3>Browsers</h3>
            <div style="margin-top: 16px;">
                {% for stat in browser_stats %}
                    <div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 4px;">
                            <span>{{ stat.browser }}</span>
                            <span>{{ stat.count }}</span>
                        </div>
                        <div style="height: 8px; background: #eee; border-radius: 4px; overflow: hidden;">
                            <div style="width: {{ (stat.count / total_visits * 100)|round }}%; height: 100%; background: #1976D2;"></div>
                        </div>
                    </div>
                {% else %}
                    <p>No data yet.</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="admin-header mt-5">
        <h2>Content Management</h2>
    </div>

    <div class="admin-grid mt-4">
        <!-- Roadmap Card -->
        <div class="card">
            <h3>Project Roadmap</h3>
            <p style="color: var(--text-secondary);">Manage planned features and releases.</p>
            <div class="admin-card-actions">
                <a href="{{ path('app_admin_roadmap') }}" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.9rem;">Manage</a>
                <a href="{{ path('app_admin_roadmap_new') }}" class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.9rem;">+ New</a>
            </div>
        </div>

        {# ... existing cards ... #}
        <!-- Licenses Card -->
        <div class="card">
            <h3>Licenses</h3>
            <p style="color: var(--text-secondary);">Total instruments: <strong>{{ license_count }}</strong></p>
            <div class="admin-card-actions">
                <a href="{{ path('app_admin_licenses') }}" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.9rem;">Manage</a>
                <a href="{{ path('app_admin_licenses_new') }}" class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.9rem;">+ New</a>
            </div>
        </div>

        <!-- News Card -->
        <div class="card">
            <h3>News & Updates</h3>
            <p style="color: var(--text-secondary);">Total posts: <strong>{{ news_count }}</strong></p>
            <div class="admin-card-actions">
                <a href="{{ path('app_admin_news') }}" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.9rem;">Manage</a>
                <a href="{{ path('app_admin_news_new') }}" class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.9rem;">+ New</a>
            </div>
        </div>

        <!-- Handbook Card -->
        <div class="card">
            <h3>Handbook</h3>
            <p style="color: var(--text-secondary);">Total pages: <strong>{{ handbook_count }}</strong></p>
            <div class="admin-card-actions">
                <a href="{{ path('app_admin_handbook') }}" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.9rem;">Manage</a>
                <a href="{{ path('app_admin_handbook_new') }}" class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.9rem;">+ New</a>
            </div>
        </div>

        <!-- Developer Portal Card -->
        <div class="card" style="border-left: 4px solid var(--pt-red); background: rgba(238, 0, 0, 0.02);">
            <h3 style="color: var(--pt-red);">Developer Portal Docs</h3>
            <p style="color: var(--text-secondary);">Manage technical & API guides.</p>
            <div class="admin-card-actions">
                <a href="{{ path('app_admin_developer_portal') }}" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.9rem; background: var(--pt-red); border: none;">Manage Portal</a>
                <a href="{{ path('app_admin_developer_portal_new') }}" class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.9rem;">+ New Guide</a>
            </div>
        </div>

        <!-- Products Card -->
        <div class="card">
            <h3>Products</h3>
             <div class="admin-card-actions">
                <a href="{{ path('app_admin_products_index') }}" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.9rem;">Manage</a>
            </div>
        </div>

        <!-- Users Card -->
        <div class="card">
            <h3>User Directory</h3>
            <div class="admin-card-actions">
                <a href="{{ path('app_admin_users') }}" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.9rem;">Manage</a>
            </div>
        </div>

        <!-- Site Settings Card -->
        <div class="card">
            <h3>Site Settings</h3>
            <div class="admin-card-actions">
                <a href="{{ path('app_admin_settings_index') }}" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.9rem;">Manage Settings</a>
            </div>
        </div>

        <!-- Community Card -->
        <div class="card">
            <h3>Community</h3>
            <p style="color: var(--text-secondary);">Total Threads: <strong>{{ community_count }}</strong></p>
            <div class="admin-card-actions">
                <a href="{{ path('app_admin_community') }}" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.9rem;">Manage Hub</a>
                <a href="{{ path('app_admin_community_category_new') }}" class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.9rem;">+ Category</a>
            </div>
        </div>

        <!-- Feedback Card -->
        <div class="card">
            <h3>Documentation Feedback</h3>
            <p style="color: var(--text-secondary);">
                {{ feedback_helpful }} / {{ feedback_total }} helpful 
                ({{ feedback_total > 0 ? (feedback_helpful / feedback_total * 100)|round : 0 }}%)
            </p>
            <div class="admin-card-actions">
                <a href="{{ path('app_admin_feedback') }}" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.9rem;">View Ratings</a>
            </div>
        </div>
        <!-- Ecosystem Map Card -->
        <div class="card" style="border-left: 4px solid #1976D2; background: rgba(25, 118, 210, 0.02);">
            <h3 style="color: #1976D2;">Ecosystem Map</h3>
            <p style="color: var(--text-secondary);">Manage interactive nodes & positions.</p>
            <div class="admin-card-actions">
                <a href="{{ path('app_admin_ecosystem') }}" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.9rem; background: #1976D2; border: none;">Manage Map</a>
                <a href="{{ path('app_admin_ecosystem_new') }}" class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.9rem;">+ New Node</a>
            </div>
        </div>
        <!-- App Showcase Card -->
        <div class="card" style="border-left: 4px solid #9C27B0; background: rgba(156, 39, 176, 0.02);">
            <h3 style="color: #9C27B0;">App Showcase</h3>
            <p style="color: var(--text-secondary);">Highlight projects building on Tick.</p>
            <div class="admin-card-actions">
                <a href="{{ path('app_admin_showcase') }}" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.9rem; background: #9C27B0; border: none;">Manage Showcase</a>
                <a href="{{ path('app_admin_showcase_new') }}" class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.9rem;">+ New App</a>
            </div>
        </div>
        <!-- License Key Gen Card -->
        <div class="card" style="border-left: 4px solid #FF9800; background: rgba(255, 152, 0, 0.02);">
            <h3 style="color: #FF9800;">Security Tools</h3>
            <p style="color: var(--text-secondary);">manually issue encrypted license keys.</p>
            <div class="admin-card-actions">
                <a href="{{ path('app_admin_license_keys') }}" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.9rem; background: #FF9800; border: none;">Key Generator</a>
            </div>
        </div>

        <!-- Automation Hub Card -->
        <div class="card" style="border-left: 4px solid #EE0000; background: rgba(238, 0, 0, 0.02);">
            <h3 style="color: #EE0000;">Automation Hub</h3>
            <p style="color: var(--text-secondary);">AI Bot logs and PR automation controls.</p>
            <div class="admin-card-actions">
                <a href="{{ path('app_admin_bot_index') }}" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.9rem; background: #EE0000; border: none;">Manage Bot</a>
            </div>
        </div>

        <!-- Infrastructure Monitoring Card -->
        <div class="card" style="border-left: 4px solid #EE0000; background: rgba(238, 0, 0, 0.05);">
            <h3 style="color: #EE0000;">Infrastructure Monitoring</h3>
            <p style="color: var(--text-secondary);">Uptime, heartbeats and health checks.</p>
            <div class="admin-card-actions">
                <a href="{{ path('admin_monitors_index') }}" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.9rem; background: #EE0000; border: none;">Manage Monitors</a>
                <a href="{{ path('app_status') }}" target="_blank" class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.9rem;">Public Status</a>
            </div>
        </div>

        <!-- Compliance & CLA Card -->
        <div class="card" style="border-left: 4px solid #000000; background: rgba(0, 0, 0, 0.02);">
            <h3 style="color: #000000;">Legal & Compliance</h3>
            <p style="color: var(--text-secondary);">Manage CLA signatures and legal documents.</p>
            <div class="admin-card-actions">
                <a href="{{ path('app_admin_cla_list') }}" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.9rem; background: #000000; border: none;">Manage CLA</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
